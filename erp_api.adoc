= TbT ERP API
MelKori <mieldo@gmail.com>
1.3.2, 2018-11-01 (1:1.3.2): ERP API
:toc: right
:toclevels: 4
{empty}

== Общая информация

Агентский API предназначен для интеграции ERP систем бизнес-агентов в сервисы TbT.

Для подключения к системе необходимо:

* иметь регистрационную запись в системе с установленным признаком **agent**
* ID учетной записи агента (UUID)
* Уникальный токен и пароль (или одноразовый сессионный код) для клиентского подключения (передаются в заголовке для Basic Auth)

К агентскому токену могут добавляться ограничения на некоторые общие типы операций: `create`, `update`, `notify`

При подключении в индифидуальном профиле создается реестр правил/классификатор обработки ТТН для каждой группы агентов (agent class) в зависимости от особенностей их данных, чтобы облегчить интеграцию.

=== Формат URL для отправки запросов к API

    https://api.tbt-post.net/api/v{v_number}/{method_name}/{method_params}?{get_params}

где::

[horizontal]
    {v_number}:: номер версии API в виде числа
    {method_name}:: название метода
    {method_params}:: параметры метода в URI
    {get_params}:: опциональные GET параметры

Для проверки запросов в командной строке/терминале, используйте User-Agent: curl, *не ниже 7.47.0*

[horizontal]

== API

=== Посылки

==== Создание посылки

[horizontal]
protocol_method:: POST
method_name:: agent/parcel
method_params:: new
request_body:: {"order_id": "<EXT Order ID>", "receiver": { "id": "<EXT User ID>", "phone": <PHONE 380XXYYYYYYY>, "email" : "<USER EMAIL>", "first name" : <FIRST NAME>, "last_name": "<LAST NAME>"}, "delivery_type": <DELIVERY TYPE>, "dest" : [ <LATITUDE>, <LONGITUDE>], "dest_apartment": "<DEST APARTMENT>", "weight" : <WEIGHT GRAM as INTEGER>, "price" : <PRICE as DECIMAL(10,2)>, "cod_amount" : <PRICE as DECIMAL(10,2)>, "type" : "<TYPE CODE>:<CLASS CODE>", "note" : "<USER NOTE>", "created_at": "<DATE TIME in ISO 8601>", "contragent_id" : <CONTRAGENT ID>, "dimensions": [<WIDTH>, <HEIGHT>, <DEPTH>], "_comment" : "<SENDER's comment>", "items": [<PARCEL ITEM SPEC>, ...]}
expected_result:: 200 {"id" : "<PARSEL ID>", "success": true}

NOTE: описание `PARCEL_ITEM_SPEC`: {"barcode": "<UNIQ BARCODE>", "sku": "<SUPPLIER SKU NAME>", "name": "<NAME>", "brand": "<BRAND>", "size": "<SIZE>", "quantity": <QUANTITY as INTEGER>, "weight": <WEIGHT GRAM as INTEGER>, "price": <PRICE as DECIMAL(10,2)>, "comment": "<OPTIONAL COMMENT>", "photo": "<OPTIONAL PHOTO>"}

NOTE: ключи `cod_amount`, `contragent_id`, `dimensions`, `_comment`, `items` -- опциональны. +
`contragent_id` - необходимо указывать если в `type=COD`

NOTE: Для посылок с классификатором оплаты `COD` в качестве значения `cod_amount` будет подставляться параметр `price` в случае отсутствия явного его указания в параметрах. `cod_amount` не может быть больше чем `price`

NOTE: параметр `delivery_type` имеет значение по-умолчанию *W2W*, в случае значений *W2D* и *D2D* необходимо передать ключ `dest_apartment`

Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X POST "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/new" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{"order_id": "TEST0001", "receiver": { "id": 0, "phone": "380662225577", "email" : "example@gmail.com", "first_name" : "test", "last_name": "user"}, "delivery_type": "W2W", "dest" : ["50.405237", "30.679338"], "dest_apartment": "26b10dbb-4f1b-4d45-9c19-ec3cb85d4253", "weight" : 1520, "price" : 2500, "cod_amount" : 0, "type" : "fragile:A.PRP.NR.NA.S000", "note" : "", "created_at": "2018-12-11T11:45:00+00:00"}'
----

В параметрах "Authorization" Необходимо указать токен и пароль в формате base64. +
Например: `token:passwd -> dG9rZW46cGFzc3dk`

Ответ::

HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Tue, 11 Dec 2018 10:32:02 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 63 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type

[source, json]
----
{
  "id": "252395d6-5764-4232-baeb-2020db2d8c2c",
  "success": true
}
----

NOTE: При повторном отправлении запроса с такими же параметрами, сервер ответит ошибкой "409" и сообщением "{"message": "Order TEST0001 already registered", "success": false}"


==== Получение по id/code

[horizontal]
protocol_method:: GET
method_name:: agent/parcel
method_params:: <PARCEL ID>
get_params:: <code>
request_body:: ----
expected_result:: 200 {"success": true, "address_id": "<SHIPPING ADDRESS ID>", "code": "<CODE-128>", "is_paid": <true/false>, "weight": <WEIGHT GRAM as DECIMAL(10,6)>, "agent": "<USER ID>", "is_open": <true/false>, "paid_at": "<TIMESTAMP UTC> or null", "closed_at": "<TIMESTAMP UTC or null>", "id": "<PARCEL ID>", "type": <TYPE CODE>, "parent": <PARCEL ID or null>, "price": <PRICE as DECIMAL(10,2)>, "cod_amount": <PRICE as DECIMAL(10,2)>, "paid_amount": <PAYMENTS TOTAL as DECIMAL(10,2)>, "class": "<CLASS ID>", "sender": "<USER ID>", "created_at": "<TIMESTAMP UTC>", "modified_at": "<TIMESTAMP UTC>", "receiver": "<USER ID>", "state": "<PARCEL STATE>", "transfer_via": "<OFFCIE ID>", "pentity": "<OFFICE ENTITY ID>", "additional_data": {...}, "delivery_type": "<DELIVERY TYPE>" ...}

CAUTION: `parcel_id` имеет более высокий приоритет, чем `code`

Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X GET "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/252395d6-5764-4232-baeb-2020db2d8c2c" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk"
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Tue, 11 Dec 2018 13:08:05 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 1114 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Etag: "ea3c10b5aa787248012184e6befffbf7732930d0" +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
  "address_id": "f50a7aaa-8a1d-11e6-8a66-83b0de5b609d",
  "code": "TEST0001",
  "weight": 1520,
  "agent": "44ee4ac5-8e42-4e40-821a-3f3e5f13f680",
  "is_dirty": false,
  "is_open": true,
  "paid_at": null,
  "closed_at": null,
  "id": "252395d6-5764-4232-baeb-2020db2d8c2c",
  "paid_amount": 0,
  "state": "PU0000",
  "mark": null,
  "last_seen_at": null,
  "type": "fragile",
  "delivery_type": "W2W",
  "parent": null,
  "price": 2500,
  "checked_in_at": null,
  "class": "A.PRP.NR.NA.S000",
  "pentity": null,
  "transfer_via": "26b10dbb-4f1b-4d45-9c19-ec3cb85d4253",
  "sender": "44ee4ac5-8e42-4e40-821a-3f3e5f13f680",
  "nsid": 0,
  "is_paid": false,
  "modified_at": "2018-12-11T10:32:02.238182+00:00",
  "success": true,
  "additional_data": {
    "erp_token": "token",
    "ttl_days": 15,
    "ttl_days_default": 15,
    "_receiver": {
      "phone": "380662225577",
      "first_name": "test",
      "last_name": "user",
      "id": 0,
      "email": "example@gmail.com"
    }
  },
  "receiver": "67719cba-5cd5-4dd0-84c9-6b6864a75066",
  "cod_amount": 0,
  "created_at": "2018-12-11T10:32:02.238169+00:00",
  "goes_back": false
}
----

==== Получение cписка посылок по списку id

[horizontal]
protocol_method:: POST
method_name:: agent/parcel/list
method_params:: ----
get_params:: <code>
request_body:: {"id": ["<PARCEL ID>", "<PARCEL ID>", ...]}
expected_result:: 200 {"success": true, "parcels": [{<PARCEL SPEC>}, {<PARCEL SPEC>}, ...]}

[]

Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X POST "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/list" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{"id": ["252395d6-5764-4232-baeb-2020db2d8c2c", "4d52c496-9137-4e8a-bb1b-56f378669ac0"]}'
----

Ответ::

HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Tue, 11 Dec 2018 14:24:13 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 2228 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +


[source, json]
----
{
  "parcels": [
    {
      "address_id": "f50a7aaa-8a1d-11e6-8a66-83b0de5b609d",
      "code": "TEST0001",
      "weight": 1520,
      "agent": "44ee4ac5-8e42-4e40-821a-3f3e5f13f680",
      "is_dirty": false,
      "is_open": true,
      "paid_at": null,
      "closed_at": null,
      "id": "252395d6-5764-4232-baeb-2020db2d8c2c",
      "paid_amount": 0,
      "state": "PU0000",
      "mark": null,
      "last_seen_at": null,
      "type": "fragile",
      "delivery_type": "W2W",
      "parent": null,
      "price": 2500,
      "checked_in_at": null,
      "class": "A.PRP.NR.NA.S000",
      "pentity": null,
      "transfer_via": "26b10dbb-4f1b-4d45-9c19-ec3cb85d4253",
      "sender": "44ee4ac5-8e42-4e40-821a-3f3e5f13f680",
      "nsid": 0,
      "is_paid": false,
      "modified_at": "2018-12-11T10:32:02.238182+00:00",
      "additional_data": {
        "erp_token": "token",
        "_receiver": {
          "phone": "380662225577",
          "first_name": "test",
          "last_name": "user",
          "id": 0,
          "email": "example@gmail.com"
        },
        "ttl_days": 15,
        "ttl_days_default": 15
      },
      "receiver": "67719cba-5cd5-4dd0-84c9-6b6864a75066",
      "cod_amount": 0,
      "created_at": "2018-12-11T10:32:02.238169+00:00",
      "goes_back": false
    },
    {
      "address_id": "f50a7aaa-8a1d-11e6-8a66-83b0de5b609d",
      "code": "TEST0002",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "created_at": "2018-12-11T14:23:51.628901+00:00",
      "goes_back": false
    }
  ],
  "success": true
}
----


==== Получение cписка посылок по участию

[horizontal]
protocol_method:: GET
method_name:: agent/parcel/list
method_params:: ----
get_params:: participant = all|agent|sender|receiver, sort_by = <SORT FIELD>, [sort_order = desc|asc], [limit=20, offset=0]
request_body:: ----
expected_result:: 200 {"total": <INTEGER TOTAL>, "parcels": [{<PARCEL SPEC>}, {<PARCEL SPEC>}, ...], "success": true}

NOTE: По-умолчанию выполняется поиск всех посылок `participant=all`, порядок сортировки по-убыванию по состояниям. В качестве sort_by можно передать такие поля: [code, weight, price, paid_amount, created_at, modified_at, paid_at, type, class, state, goes_back]

NOTE: Параметры в GET запросах необходимо перечислять через символ `&` +
Параметры в [] - опциональны

Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X GET "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/list?participant=agent&sort_by=type&sort_order=asc&limit=20&offset=0" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk"
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 10:22:47 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 3337 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Etag: "35c21fc7f5e3aa7aecbdc4389aa4b8097372f81c" +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +
[source, json]
----
{
  "total": 3,
  "parcels": [
    {
      "address_id": "f50a7aaa-8a1d-11e6-8a66-83b0de5b609d",
      "code": "TEST0003",
      "weight": 145,
      "agent": "44ee4ac5-8e42-4e40-821a-3f3e5f13f680",
      "is_dirty": false,
      "is_open": true,
      "paid_at": null,
      "closed_at": null,
      "id": "0e1837e3-609f-4bc6-a121-3b21c0f11a5b",
      "paid_amount": 0,
      "state": "PU0000",
      "mark": null,
      "last_seen_at": null,
      "type": "fragile",
      "delivery_type": "W2W",
      "parent": null,
      "price": 125,
      "checked_in_at": null,
      "class": "A.PRP.NR.NA.S000",
      "pentity": null,
      "transfer_via": "26b10dbb-4f1b-4d45-9c19-ec3cb85d4253",
      "sender": "44ee4ac5-8e42-4e40-821a-3f3e5f13f680",
      "nsid": 0,
      "is_paid": false,
      "modified_at": "2018-12-12T10:19:42.207810+00:00",
      "additional_data": {
        "erp_token": "510ad08a-830e-46aa-ab63-dfade75a00a7",
        "_receiver": {
          "phone": "380662225577",
          "first_name": "test",
          "last_name": "user",
          "id": 0,
          "email": "example@gmail.com"
        },
        "ttl_days": 15,
        "ttl_days_default": 15
      },
      "receiver": "67719cba-5cd5-4dd0-84c9-6b6864a75066",
      "cod_amount": 0,
      "created_at": "2018-12-12T10:19:42.207796+00:00",
      "goes_back": false
    },
    {
      "address_id": "f50a7aaa-8a1d-11e6-8a66-83b0de5b609d",
      "code": "TEST0002",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "created_at": "2018-12-11T14:23:51.628901+00:00",
      "goes_back": false
    },
    {
      "address_id": "f50a7aaa-8a1d-11e6-8a66-83b0de5b609d",
      "code": "TEST0001",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "PARCEL SPEC",
      "created_at": "2018-12-11T10:32:02.238169+00:00",
      "goes_back": false
    }
  ],
  "success": true
}
----

==== Получение кодов

[horizontal]
protocol_method:: GET
method_name:: agent/parcel/codes
method_params:: <PARCEL ID>
request_body:: ----
expected_result:: 200 {"qr": "<QR body>", "bcode": "<CODE128>", "success": true}

[]

Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X GET "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/codes/4d52c496-9137-4e8a-bb1b-56f378669ac0" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk"
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 10:49:02 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 4040 +
Connection: keep-alive
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Etag: "2b06b6d02fb247c191d703bb325ca1173138a2bd" +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
  "qr": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALIAAACyAQAAAADO8ajFAAAE9klEQVR4nNVXz4fl1xKv7ro8TY0aZvUITxjeqqlWTQxnVG8fTf6GEN52yCpkE7J9hLcaQv6JkNVwWg0jnOtcejU0EYaswmnn0oa6KvuYe2b73ndZPj4+p+pTP74nCR/6bk4/GAb434ufbG5gu7+4fL2Fy93F9vkF3J9cHcVD2kzpYEoZrbA1G5pWj+NFYXD1rpXnyJRExY/graQgzvQ6baCv8BsA0K3CzvaPujyy76/GJ+8er97L9TD3FwZv84u3tpPd3R8Qx/EneYLyl9hhZ98e15/JgNUKBjYrzKNa5lH9p3Cxedef4Q0UfLW/eVOfXsP95rgeyOzRZEy1UOaEIVj9OD+kj+iDWKq2mZTUs41V/iMiHIAyfNbRRafiih+d2aYnSyP1FjLW/NamVVRlQx6TsxAv+dUdc7QiHk6UVD14xQ+cnjxrrz2nNnFAWPEXt5jQB5hW66hZmqzwPUCbhvamXSqnGC/zz97KHFCGxjCs0j3myg/w7Kvb7Z29/sfZZ7++qsSfnl3uVn6Q2pUkajcHLRPIC630TJrQU91HcgB1YY1lP6I4QiWp4eJTEput8JMFotPMhoa1tJk8V/gK6OpAU9PBYKSDLfWbyWCD5mgGvWna2j8KA1WlS1YFIQ1d1PcUiOj6jwPhpz88fkFwp98/odvVPEQgagHGMjowysf0a8PGMcFqS1WOSiGr/BCgaPbpNls1KhXX7+VGOQBpVjAaLWuWsXqv7J9e7Pzgb7/Jb//568ONbeB65TdOKzZH1Tp6KUqTaOkf9jJkAHWzhp7R/CP1ChvNlAXrNCgMSbriVy/dgA3LDOsK3cuiH0/hP9coYOeH9w/bN/cXZwyH11er+lYdPcGxy+w9fWLaUg83iFkJJrlNaUWaLudDl+ZzAgoXpJ7Fci7mA+RoNCWpsSiGdZutLfmreEWJUm106kmZsfADJLYcwc25aBfkAZV1hW+VipUs0dBgNG595TfIliZt9tJj9Cg0jfvSD71maZYaHSJaYMux2KeQQeAEkT3UWRNHNz6O38Dtnq/G1cb2rwjuz24KXR5k5X8yADaD5EFWMI1tcZ+cwu97hXf3ezr56e6n/Zv3j74b+2d1wa+GoGiUA8nIB6Et910CBjZAVmQQK81gub+iiGZYjUAayaE0lv4BmRW1ZdXwbJMi1/wjq0yChjF9DKfksfRzOk4SKMDKhUSz05J/ZiuljsJ9NJ/QlVb3FSTOoZheAWOSOmSHRT43QP/aE5xI9xc70Puz8pqq8NF7fgO/Xf24h6//u5EDwuHu3/Vs/8lY+af2Ku4QIhoji2vRZX4cBhWyItl76qTW1/1bqClIL7WhhTaakUt+kCg0yQemRx9aZln0yykwP7l993c/7N5fnm/2n798uHvzdDk/PUCS2WV61yCrddnvNdSxB1pHEyBz60t/qhSHPjpqZDMU9rK8t4HhEF88+bJt/7bZv/qFf3vx3W6pf3ogz8Fm3tkH1SzLedWQreCMRkUGcc2sy/cO645AVWaAqWSF5b2aaV3BhGlWo0rQ1/sIsKmLFpd0RS4zdTHPT8HGVy+v7+ih7HZC5wd8fqDD8v5Ubh5QqBcD7WU6LPMjqoDDpwUCh88p0Zf1grfzl+uvt9uHcz5/oLPnP3y2X+mxOaKn4CTXLEMkaeH/Ddw8PgfejtudfvPyBm8J4eez1f/gB8P/N//7fwKlha0A3o4jOwAAAABJRU5ErkJggg==",
  "bcode": "data:image/png;base64,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",
  "success": true
}
----

NOTE: Если вставить полученный код в строке браузера, напримпр: "Crhome", то в результате получим изображение необходимого кода. Копировать необходимо без скобок, например: `data:image/png;base64,iV...<body>...U5ErkJggg==`


==== Состояние посылки

[horizontal]
protocol_method:: GET
method_name:: agent/parcel/track
method_params:: <PARCEL ID>
request_body:: ----
expected_result:: 200 {"modified_at" : "<TIMESTAMP UTC>", "code" : "<CODE ID>", "geo" : [ <LATITUDE>, <LONGITUDE>], "success": true, "state_desc" : "<STATE DESCR>"}

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X GET "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/codes/4d52c496-9137-4e8a-bb1b-56f378669ac0" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk"
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 11:43:01 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 302 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Etag: "ccbb8b78e88fca92e5d705649a731f736f74ee55" +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
  "modified_at": "2018-12-12T10:42:49.430110+00:00",
  "code": "PU0000",
  "geo": [
    0,
    0
  ],
  "success": true,
  "state_desc": "Заявка зарегистрирована в системе"
}
----

==== История изменения состояний

[horizontal]
protocol_method:: GET
method_name:: agent/parcel/log
method_params:: <PARCEL ID>
request_body:: ----
expected_result:: 200 {"<TIMESTAMP UTC>" : {"code" : "<CODE ID>", "geo" : [ <LATITUDE>, <LONGITUDE>], "state_desc" : "<STATE DESCR>"}, ..., "success": true}

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X GET "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/log/4d52c496-9137-4e8a-bb1b-56f378669ac0" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk"
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 11:43:01 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 302 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Etag: "ccbb8b78e88fca92e5d705649a731f736f74ee55" +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
    "1542777583615": {
        "code": "PU0001",
        "geo": [
            0,
            0
        ],
        "state_desc": "Отправление принято к доставке"
    },
    "1542880237734": {
        "code": "PU0003",
        "geo": [
            0,
            0
        ],
        "state_desc": "В отделении"
    },
    "1543160738969": {
        "code": "PU0007",
        "geo": [
            0,
            0
        ],
        "state_desc": "Доставлено"
    },
    "success": true
}
----



==== История изменения состояний всех посылок

[horizontal]
protocol_method:: GET
method_name:: agent/parcel/
method_params:: logs
get_params:: ts_from=<TIMESTAMP UTC> [, ts_to=<TIMESTAMP UTC>, state=<PARCEL STATE>]
request_body:: ----
expected_result:: 200 {"logs": [{"<TIMESTAMP UTC>" : {"code" : "<CODE ID>", "geo" : [ <LATITUDE>, <LONGITUDE>], "state_desc" : "<STATE DESCR>"}, "id": <PARCEL ID>}, {"<TIMESTAMP UTC>" :  {…​}, …​}, …], "success": true}


, 


NOTE: Временные параметры `ts_from`, `ts_to` задаются в формате timestamp UTS *in miliseconds*.

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X GET "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/log/logs?ts_from=1542880237734, ts_to=1542880237734, state="PU0007" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk"
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 11:43:01 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 302 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Etag: "ccbb8b78e88fca92e5d705649a731f736f74ee55" +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
"logs": [
        {
            "1544628934289": {
                "code": "PU0007",
                "geo": [
                    0,
                    0
                ],
                "state_desc": "Доставлено"
            },
            "id": "ad0a7e57-5932-4e6f-86c3-c72df9fb317f"
        },
        {
            "1544628989049": {
                "code": "PU0007",
                "geo": [
                    0,
                    0
                ],
                "state_desc": "Доставлено"
            },
            "id": "0d575a34-bc24-4a77-bee7-018657311581"
        },
        {
            "1544628596582": {
                "code": "PU0007",
                "geo": [
                    0,
                    0
                ],
                "state_desc": "Доставлено"
            },
            "id": "fba18a75-e47e-4ca7-b22e-53416baad354"
        }
    ],
    "success": true
}
----



==== Модификация зарегистрированой посылки

[horizontal]
protocol_method:: PUT
method_name:: agent/parcel/alter
method_params:: <PARCEL ID>
request_body:: { "receiver": { "id": "<MK User ID>", "phone": <PHONE 380XXYYYYYYY>, "email" : "<USER EMAIL>", "first name" : <FIRST NAME>, "last_name": "<LAST NAME>"}, "delivery_type": "<DELIVERY TYPE>", "dest" : [ <LATITUDE>, <LONGITUDE>], "dest_apartment": "<APARTMENT>", "weight" : <WEIGHT GRAM as INTEGER>, "price" : <PRICE as DECIMAL(10,2)>, "cod_amount" : <PRICE as DECIMAL(10,2)>, "type" : "<TYPE CODE>:<CLASS CODE>", "note" : "<USER NOTE>", "contragent_id" : <CONTRAGENT ID>, "dimensions": [<WIDTH>, <HEIGHT>, <DEPTH>], "_comment" : "<SENDER's comment>"}
expected_result:: 202 {"success": true}

NOTE: Все ключи -- опциональны, некоторые ключи имеют в зависимостях другие ключи: например `dest` связан с `delivery_type`, `dest_apartment`

IMPORTANT: Изменения применимы только для состояния `Заявка зарегистрирована в системе` (`state == PU0000`)

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X PUT "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/alter/0e1837e3-609f-4bc6-a121-3b21c0f11a5b" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{"receiver": { "id": 0, "phone": "380667265627", "email": "bulikj@gmail.com", "first_name" : "Юлия", "last_name": "Верещак"}, "delivery_type": "W2W", "dest": ["50.405237", "30.679338"], "dest_apartment": "26b10dbb-4f1b-4d45-9c19-ec3cb85d4253","weight": 145, "price": 125, "cod_amount" : 0, "type": "fragile:A.PRP.NR.NA.S000", "note": "example information", "dimensions": [250, 400, 80], "_comment" : "test parcel"}'
----

Ответ::
HTTP/1.1 202 Accepted +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 12:15:53 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 17 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
  "success": true
}
----

NOTE: Если состояние отправления не позволяет выполнить запрос, будет получена ошибка с кодом `409` и сообщением {"message":"Inappropriate parcel state","success":false}


==== Запрос на изменение посылки после принятия к доставке

[horizontal]
protocol_method:: PUT
method_name:: agent/parcel/update
method_params:: <PARCEL ID>
request_body:: { "receiver": { "id": "<MK User ID>", "phone": <PHONE 380XXYYYYYYY>, "email" : "<USER EMAIL>", "first name" : <FIRST NAME>, "last_name": "<LAST NAME>"}, "price" : <PRICE as DECIMAL(10,2)>, "cod_amount" : <PRICE as DECIMAL(10,2)>}
expected_result:: 202 {"success": true}

NOTE: `receiver` опциональный, `cod_amount` и `paid_amount` необходимо передавать парой, изменение возможно только в меньшую сторону по сравнению с начальным значением и доступно только для типов отправлений с COD

IMPORTANT: Запрос на модификацию возможен в состояних `Принято к доставке` (`state == PU0001`) и `В отделении` (`state == PU0003`)

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X PUT "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/update/30ca60d8-7d9b-47b3-a7b7-e40ff2fdefd2" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{"price" : 350, "cod_amount" : 299}'
----

Ответ::
HTTP/1.1 202 Accepted +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 13:45:30 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 17 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +
[source, json]
----
{
  "success": true
}
----

==== Подтверждение платежа

[horizontal]
protocol_method:: POST
method_name:: agent/parcel/paid
method_params:: <PARCEL ID>
request_body:: { "amount": <PRICE as DECIMAL(10,2)>, "payment_id": "<ID as STRING>"}
expected_result:: 200 {"success": true}

IMPORTANT: Изменения не применимы для состояния `Доставлено` (`state == PU0007`)

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X POST "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/paid/30ca60d8-7d9b-47b3-a7b7-e40ff2fdefd2" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{"amount": 299, "payment_id": "test0001"}'
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 13:59:40 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 17 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +
[source, json]
----
{
  "success": true
}
----



==== Установка времени хранения посылки на отделении

[horizontal]
protocol_method:: PUT
method_name:: agent/parcel/ttl
method_params:: <PARCEL ID>
request_body:: {"ttl_days": <INTEGER>}
expected_result:: 200 {"success": true}

NOTE: `ttl_days` возможно передать в диапазоне parcel: `additional_data->>ttl_days`, `additional_data->>ttl_days_max OR additional_data->>ttl_days * 2`

NOTE: Максимальное время хранения и время хранения по умолчанию задается в настройках erp-токена при создании. Если выполнение запроса завершилось ошибкой с кодом ответа `400` и сообщением (пример) `{"message": "{\"error\":\"ttl_days: not in range 10 20\"}", "success": false}` - это значит, что превышено минимальное или максимальное время хранения.

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X PUT "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/ttl/30ca60d8-7d9b-47b3-a7b7-e40ff2fdefd2" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{"ttl_days": 11}'
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 6 +
Date: Wed, 12 Dec 2018 15:30:18 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 17 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
  "success": true
}
----

==== Пометка посылки к отмене на отделении

[horizontal]
protocol_method:: PUT
method_name:: agent/parcel/mark-cancel
method_params:: <PARCEL ID>
request_body:: ----
expected_result:: 200 {"success": true}

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X PUT "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/mark-cancel/30ca60d8-7d9b-47b3-a7b7-e40ff2fdefd2" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{}'
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 16:09:54 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 17 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +

[source, json]
----
{
  "success": true
}
----

==== Проверка условий доставки для посылки перед регистрацией

[horizontal]
protocol_method:: POST
method_name:: agent/parcel/delivery-check
method_params:: ----
request_body:: {"delivery_type": <DELIVERY TYPE>, "dest" : [ <LATITUDE>, <LONGITUDE>], "weight" : <WEIGHT GRAM as INTEGER>, "price" : <PRICE as DECIMAL(10,2)>, "type" : "<TYPE CODE>"}
expected_result:: 200 {"success": true, "transfer_via": "<office_id>", "route_mark": "<mark>"}

NOTE: В случае каких-либо ошибок валидации параметров будет возвращен статус 400 с описанием ошибки. +
"route_mark" будет отображен при типе доставки "курьерская доставка"

[]
Пример запроса/ответа::
Запрос::
[source, shell]
----
curl -v -X POST "https://sandbox-api.tbt-post.net/api/v1/agent/parcel/delivery-check" \
-H "Content-Type: application/json" \
-H "Authorization: Basic dG9rZW46cGFzc3dk" \
-d '{"delivery_type": "W2W", "dest" : ["50.405237", "30.679338"], "weight" : 10000, "price" : 23000, "type" : "undef:A.COD.NR.NA.S000"}'
----

Ответ::
HTTP/1.1 200 OK +
Server: nginx/1.10.3 +
Date: Wed, 12 Dec 2018 16:34:19 GMT +
Content-Type: application/json; charset=utf-8 +
Content-Length: 73 +
Connection: keep-alive +
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS +
Access-Control-Max-Age: 600 +
Access-Control-Allow-Credentials: true +
Access-Control-Allow-Origin: https://sandbox-ui.tbt-post.net +
Access-Control-Allow-Headers: Content-Type +
[source, json]
----
{
  "transfer_via": "26b10dbb-4f1b-4d45-9c19-ec3cb85d4253",
  "success": true
}
----

=== Отделения и адреса

==== Получения данных отделений

[horizontal]
protocol_method:: GET
method_name:: offices
get_params:: <lang>
request_body:: ----
expected_result:: 200
{
    "offices": [
    {
        "id": "<OFFICE ID>",
        "name": "<OFFICE NAME>",
        "descr": "<OFFICE LONG NAME>",
        "number": <OFFICE NUMBER>,
        "phone": "<OFFICE PHONE>",
        "email": "<OFFICE EMAIL>",
        "address": { <ADDRESS SPEC> },
        "address_data": {
            "index": "<POST CODE>",
            "floor": <NUM>,
            ...
            <OPTIONAL OTHER DATA>
        },
        "schedule": {
            "1": "<OPEN_TIME-CLOSE_TIME | STATUS>",
            "2": "<OPEN_TIME-CLOSE_TIME | STATUS>",
            ...
            "7": "<OPEN_TIME-CLOSE_TIME | STATUS>",
        },
        "optimal_hours": {<OPTIMAL WORKING HOURS>},
        "photos": ["<PHOTO URL>", ...],
        "way_photos": ["<PHOTO URL>", ...],
        "pay_cash": true|false,
        "pay_card": true|false,
        "additional_data": {
            "sms_addr": "<SMS ADDRESS>",
            "code_prefix": "<OFFICE CODE PREFIX>",
            "label": "<OFFICE LABEL>"
        },
        "ui_address": "<ADDRESS LINE>"
    },
    .....
    ],
    "success": true
}

==== Получение данных адреса из справочника

[horizontal]
protocol_method:: GET
method_name:: address
get_params:: <lang, <lat,lon> | <region,city,street,building>>
request_body:: ----
expected_result:: 200 {"success": true, "lang": "<LANG>", "city": "<CITY>", "building": "<BUILDING>", "area": "<ADDRESS AREA or null>", "country": "<COUNTRY CODE>", "region": "<CITY REGION or null>", "lon": <LONGITUDE>, "lat": <LONGITUDE>, "id": "<SHIPPING ADDRESS ID>", "note": "<TEXT or null>", "modified_at": "<TIMESTAMP UTC>", "street": "<STREET>", "addr_type": "<TYPE ID>", "accuracy": "<ADDRESS ACCURACY>", "geo_source": "<google|yandex|osm>", "geo_object": {<ADDITIONAL GEO DATA>}}

NOTE: в качестве get-параметров указывается _либо_ пара гео-координат, _либо_ cоставные части адреса `region`, `city`, `street`, `building` 

=== Пользователи

==== Регистрация пользователя

[horizontal]
protocol_method:: POST
method_name:: agent/user
method_params:: ----
request_body:: { "email": "<EMAIL>", "phone": "<PHONE>", "first_name": "<FIRST NAME>", "last_name": "<LAST NAME>", "gender": "male|female|undef", "birthday": "1970-01-01", "company": { "name": "<COMPANY NAME>", "reg_id": "<REG ID>", "tax_id": "<TAX ID>", "type": "company|pe" } }
expected_result:: 200 { "user_id": "<USER ID>", "success": true }

==== Поиск пользователя

protocol_method:: GET
method_name:: agent/user
get_params:: phone, reg_id, tax_id, company
request_body:: ----
expected_result:: 200 {"users": [{"first_name": "<FIRST NAME>", "last_name": "<LAST NAME>", "company": {"name": "<COMPANY NAME>", "modified_at": "2018-07-10T09:15:52.366826+00:00", "reg_id": "<REG ID>", "type": "company", "tax_id": "<TAX ID>"}, "email": "<EMAIL>", "phone": "PHONE", "id": "<USER ID>"}], "success": true}


=== Контрагенты

==== Регистрация контрагента

[horizontal]
protocol_method:: POST
method_name:: agent/contragent
method_params:: ----
request_body:: {"name": "<CONTRAGENT NAME>", "reg_id": "<REGISTRATION ID>", "tax_id": "<TAX ID>", "vat": <VALUE ADDED TAX (INT(%))>, "bank_name": "<BANK NAME>", "bank_mfo": "<BANK MFO CODE>", "bank_account": "<ACCOUNT ID>"}
expected_result:: 200 {"success": true, "id" : "<CONTRAGENT ID>"}

[NOTE]
====

Параметры: `reg_id` -- код ЕДРПОУ контрагента, `tax_id` -- ИНН контрагента, `vat` - ставка НДС в процентах. `vat == 0` -- эквивалент `без НДС`.

После регистрации контрагента, необходим запрос почтой на его активацию.

====

==== Модификация контрагента

[horizontal]
protocol_method:: PUT
method_name:: agent/contragent
method_params:: <CONTRAGENT ID>
request_body:: {"name": "<CONTRAGENT NAME>", "reg_id": "<REGISTRATION ID>", "tax_id": "<TAX ID>", "vat": <VALUE ADDED TAX (INT(%))>, "bank_name": "<BANK NAME>", "bank_mfo": "<BANK MFO CODE>", "bank_account": "<ACCOUNT ID>"}
expected_result:: 200 {"success": true, "id" : "<CONTRAGENT ID>"}

NOTE: Все ключи являются опциональными

IMPORTANT: После модификации контрагента сбрасывается статус активации, и необходимо отправлять запрос активации заново

==== Информация о контрагенте

[horizontal]
protocol_method:: GET
method_name:: agent/contragent
method_params:: <CONTRAGENT ID>
request_body:: ----
expected_result:: 200 {"success": true, "name": "<CONTRAGENT NAME>", "reg_id": "<REGISTRATION ID>", "tax_id": "<TAX ID>", "vat": <VALUE ADDED TAX INT(%)>, "bank_name": "<BANK NAME>", "bank_mfo": "<BANK MFO CODE>", "bank_account": "<ACCOUNT ID>", "enabled": <true|false>, "modified_at": <TIMESTAMP UTC>, "translations": [{"processor": <POS PROCESSOR>, "merchant_id": <POS MERCHANT ID>, {...}, ...}]}

==== Справочник контрагентов

[horizontal]
protocol_method:: GET
method_name:: agent/contragent
method_params:: list
request_body:: ----
expected_result:: 200 {"success": true, "contragents": [{<CONTRAGENT SPEC>}, ...]}

=== Финансовые транзакции

==== Получение финансовой транзакции по id

[horizontal]
protocol_method:: GET
method_name:: agent/fin-transaction
method_params:: <TRANSACTION ID>
get_params:: ----
request_body:: ----
expected_result:: 200 {"success": true, "id": "<TRANSACTION ID>", "sender": "<SENDER USER ID>", "contragent": "<CONTRAGENT ID>", "processor": "<POS PROCESSOR TYPE>", "amount": <PRICE as DECIMAL(10,2), "trans_type": "<TRANSACTION TYPE: parcel|p2p>", "trans_ref": "<PARCEL ID>", "addidional_data": {"id": <POSORDER ID>, ... < OTHER SPECIFIC DATA >}, "created_at": <TIMESTAMP UTC>, "modified_at": <TIMESTAMP UTC>, "completed_at": <TIMESTAMP UTC>, "is_completed": true|false, "is_appiled": true|false}

NOTE: На данный момент существуют только транзакции с `trans_type == "parcel"`, в таком случае `trans_ref` ссылается на `<PARCEL ID>`

NOTE: `processor` на данный момент может быть: `fcs_term` - оплата через терминал, `_erp_api` - оплата через вызов API *agent/parcel/paid*

==== Получение списка финансовых транзакций за период

[horizontal]
protocol_method:: GET
method_name:: agent/fin-transactions
method_params:: ----
get_params:: ts_from=<TIMESTAMP UTC> [, ts_to=<TIMESTAMP UTC>, processor=fcs_term|_erp_api, contragent=<CONTRAGENT ID>, is_dirty=true limit=200, offset=0]
request_body:: ----
expected_result:: 200 {"success": true, "transactions": [{<TRANSACTION SPEC>}, {<TRANSACTION SPEC>}, ...], "total": <INTEGER>}

NOTE: Временные параметры `ts_from`, `ts_to` задаются в формате timestamp UTS *in miliseconds*. Параметр `is_dirty` указывает на получение транзакций, которые не синхронизированы с агентской системой в связи с какими-либо ошибками.

==== Получение списка финансовых транзакций по посылке

[horizontal]
protocol_method:: GET
method_name:: agent/parcel/fin-transactions
method_params:: <PARCEL ID>
get_params:: ----
request_body:: ----
expected_result:: 200 {"success": true, "transactions": [{<TRANSACTION SPEC>}, {<TRANSACTION SPEC>}, ...]}

[horizontal]
==== Пример запроса:

request:: https://api.tbt-post.net/api/v1/agent/parcel/fin-transactions/c154aafe-2142-4959-be8e-3adead117e76
response:: 200 {
    "success": true, 
    "transactions": [
        {
            <TRANSACTION SPEC>,
            "summ": 341.0, 
            "date": 2018-12-07T12:08:21.519346+00:00
            <TRANSACTION SPEC>,
            ....
        }
    ]
}
